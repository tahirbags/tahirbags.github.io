<!DOCTYPE html>
<html> 

<style>

body {
  font-family: 'Proxima Nova', sans-serif;
}
  
.hidden { display: none; }

//annotation stuff
.annotation circle {
  fill: yellow;
  stroke: black;
  opacity: 0.5;
}

.annotation path {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}

.annotation text {
  text-shadow: -2px 0 2px #fff, 
                0 2px 2px #fff,
                2px 0 2px #fff, 
                0 -2px 2px #fff;
}

  
.g-hed {
  text-align: left;
  text-transform: uppercase;
  font-weight: bold;
  font-size:22px; 
  margin: 3px 0;
}

.g-source-bold {
  text-align: left;
  font-size:10px;
  font-weight: bold; 
}

.g-source-reg {
  text-align: left;
  font-size:10px; 
}

.g-source {
  margin: 10px 0;
}

.g-intro {
  font-size: 16px;
  margin: 0px 0px 10px 0px;
}

.states {
  fill: #d3d3d3;
  stroke: #ffffff;
  stroke-linejoin: round;
}

div.tooltip {
  position: absolute;
  left: 75px;
  text-align: center;
  height: 35px;
  padding: 8px;
  font-size: 13px;
  font-family: 'Proxima-Nova', sans-serif;
  background: #FFFFFF;
  border: 1px solid #989898;
  pointer-events: none;
}

.block {
  width:10%;
  height: 15px;
  display:inline-block;
} 
</style>

<body>
  <h5 class="g-hed"></h5>
  <p class="g-intro"></p>
  <div class="pagination">
    <a href="line.html">&laquo;</a>
    <a class="active" href="casesmap.html">US Cases</a>
    <a href="map.html">US Mortalities</a>
    <a href="line.html">US States with Best Responses</a>
    <a href="casesmap.html">&raquo;</a>
  <div class="g-source"><span class="g-source-bold"></span><span class="g-source-reg"></span></div>

  <form> 
      <select id ="dropdown"> 
          <option value="Illinois">Select a State (default: Illinois)</option>
          <option value="California">California</option>
          <option value="New York">New York</option>
          <option value="Texas">Texas</option>
          <option value="Florida">Florida</option>
          <option value="Illinois">Illinois</option>
          <option value="Michigan">Michigan</option>
          <option value="Connecticut">Connecticut</option>
          <option value="Massachusetts">Massachusetts</option>
          <option value="New Jersey">New Jersey</option>
      </select>
  </form>
  
  <style>
      /* Apply  styles to the dropdown */
      #dropdown {
        margin-left: 100px;
        margin-top: 50px;
        height: 30px;
        font-size: 15px; 
        color: black;
      }
    </style>
    
</body>  
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="d3-ring-note.js"></script>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<body onload="init()">

    
  <div id="chart"></div>
<script>

//create get_data function include filter state, count cases/deaths, sorting 
        function get_data(data, keyword) {
            var filtered_data = data.filter(function(d){   
                return d.state===keyword;
                                        });

            fetch_data = filtered_data.map(function(d) { 
                    return { 
                        state: d.state,
                        date: new Date(d.date), 
                        daily_deaths: d['daily deaths'],
                        daily_cases: d['daily cases']
                    }
            })

            var compareDates = function(a, b) {
                    return d3.ascending(a.date, b.date);
                        };
            return fetch_data.sort(compareDates);

        }

        const width = 800;
        const height = 400;
        const margin = { top: 40, right: 40, bottom: 60, left: 80 };

        //Appends chart headline
        d3.select(".g-hed").text("Heat Map of COVID-19 Cases in US States in 2020");

        //Appends chart intro text
        d3.select(".g-intro").text("This visualization is a Heat Map of the United States, where each state is shaded according to the total number of COVID-19 cases recorded in 2020. The color gradient ranges from light to dark, with lighter shades representing lower case counts and darker shades indicating higher case counts. This map provides a clear geographic perspective on the spread and intensity of the pandemic across different states.The states with the darkest shades, such as New York, California, and Texas, show the highest number of cases, reflecting the early and intense outbreaks in densely populated areas. Conversely, states like Vermont and Wyoming, with lighter shades, indicate relatively fewer cases. This visualization helps identify the regions most impacted by the pandemic and underscores the variability in case numbers across the country, highlighting the importance of tailored public health responses.");

        // Create an SVG element
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
        
        async function init() { 
            const data = await d3.csv("us-states-2020.csv");
            var ele = document.getElementById("dropdown");

            //use show function to  respond to an event after change in dropdown
            function showChart() {
            //get element in dropdown
           //     var keyword = "US"
            fetch_data = get_data(data, ele.value);
            
       //append x and y axis temporary
         svg.append("g")
            .attr("transform", "translate("+0+", "+height+")")
            .attr("class", "x_axis");  

        svg.append("g")
            .attr("class", "y_axis");

     // set up xScale and yScale for next setp
            const xScale = d3.scaleTime()
                     .domain(d3.extent(data, d => new Date(d.date) ))
                     .range([0, width]);

                     const yScale = d3.scaleLinear()
                        .domain([d3.min(fetch_data, d=> +d.daily_cases), d3.max(fetch_data, d=> +d.daily_cases)])
                        .range([height, 0]); 
          
          
        //append x and y axis with time effect
            svg.selectAll(".x_axis").transition()
                     .duration(3000)
                    .call(d3.axisBottom(xScale));

            svg.selectAll(".y_axis").transition()
                    .duration(2000)
                   .call(d3.axisLeft(yScale));

                   var max_cases=d3.max(fetch_data, d=> +d.daily_cases);
                // Set the gradient 
                //(code taken from: https://www.d3-graph-gallery.com/graph/line_color_gradient_svg.html)
                d3.select("svg").append("linearGradient")
                .attr("id", "line-gradient")
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", 0)
                .attr("y1", yScale(0))
                .attr("x2", 0)
                .attr("y2", yScale(max_cases))
                .selectAll("stop")
                    .data([
                    {offset: "0%", color: "blue"},
                    {offset: "100%", color: "orange"}
                    ])
                .enter().append("stop")
                    .attr("offset", function(d) { return d.offset; })
                    .attr("stop-color", function(d) { return d.color; })
           
            // Add the line
               svg.selectAll(".chart_line")
                    .data([fetch_data], function(d) { return d.date })
                    .join("path")
                    .attr("class", "chart_line")
                        .transition()
                        .duration(2000)
                        .attr('stroke', 'url(#line-gradient') 
                        .attr('fill', 'none')
                        .attr('stroke-width', '2')
                        .attr('d', d3.line()
                            .x(function(d) { return xScale(d.date); })
                            .y(function(d) { return yScale(d.daily_cases); }));

                // Define a tooltip element, define mouseover
            const tooltip = d3.select(".tooltip")
                .style("position", "absolute")
                .style("pointer-events", "none")
                .style("opacity", 0) ;

            // Append a transparent overlay on top of the line to capture mouse events
            svg.append("rect")
                .style("fill", "none")
                .style("pointer-events", "all")
                .on("mousemove", function (event) {
                    const dataPoint = fetch_data[index - 1];

                    // Update data point
                    tooltip
                        .html(`Date: ${dataPoint.date.toDateString()}<br>Daily Deaths: ${dataPoint.daily_deaths}`)
                        .style("left", `${mouseX}px`)
                        .style("top", `${yScale(dataPoint.daily_deaths) - 30}px`)
                        .style("opacity", 1);
                })
                .on("mouseout", function () {
                    // Hide data if mouse off
                    tooltip.style("opacity", 0);
                });
               
                // Chart labels
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom)
                    .attr("text-anchor", "middle")
                    .text("Date  (Year 2020)");

                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 10 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Change in number of cases per day");
        }
          ele.onchange = showChart;
          showChart();
    }
     
    </script>

</body>

</html>
